local UILibrary = {}
UILibrary.__index = UILibrary

local cloneref = cloneref or function(x) return x end
local gethui = gethui or function() return nil end

local UIS = cloneref(game:GetService("UserInputService"))
local CoreGui = cloneref(game:GetService("CoreGui"))
local TweenService = cloneref(game:GetService("TweenService"))

local function createCorner(parent, radius)
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, radius or 6)
	c.Parent = parent
	return c
end

local function createStroke(parent, color, thickness)
	local s = Instance.new("UIStroke")
	s.Color = color or Color3.fromRGB(70, 70, 70)
	s.Thickness = thickness or 1
	s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	s.Transparency = 0.5
	s.Parent = parent
	return s
end

local function tween(obj, props, duration, style, direction)
	local info = TweenInfo.new(duration or 0.2, style or Enum.EasingStyle.Quad, direction or Enum.EasingDirection.Out)
	local t = TweenService:Create(obj, info, props)
	t:Play()
	return t
end

UILibrary.Theme = {
	MainBackground = Color3.fromRGB(18, 18, 22),
	SecondaryBackground = Color3.fromRGB(28, 28, 35),
	TertiaryBackground = Color3.fromRGB(38, 38, 45),
	ElementBackground = Color3.fromRGB(45, 45, 55),
	AccentColor = Color3.fromRGB(88, 166, 255),
	AccentHover = Color3.fromRGB(108, 186, 255),
	AccentDark = Color3.fromRGB(68, 146, 235),
	HoverColor = Color3.fromRGB(55, 55, 65),
	PrimaryText = Color3.fromRGB(255, 255, 255),
	SecondaryText = Color3.fromRGB(220, 220, 230),
	TertiaryText = Color3.fromRGB(180, 180, 190),
	MutedText = Color3.fromRGB(140, 140, 150),
	ScrollBarColor = Color3.fromRGB(100, 100, 110),
	StrokeColor = Color3.fromRGB(70, 70, 80),
	CornerRadius = 8,
	ButtonCornerRadius = 6,
	TitleBarHeight = 36,
	TabBarHeight = 38,
	ElementHeight = 32,
	ElementPadding = 6,
	ContainerPadding = 10
}

function UILibrary:CreateWindow(config)
	local w = setmetatable({}, UILibrary)
	config = config or {}

	w.Title = config.Title or "UI Panel"
	w.Size = UDim2.fromOffset(360, 333)
	w.MinimizeKey = config.MinimizeKey or Enum.KeyCode.RightControl
	w.Connections, w.Elements, w.Tabs = {}, {}, {}
	w.ActiveTab, w.IsMinimized = nil, false

	local parent = gethui() or CoreGui

	local existing = parent:FindFirstChild("67Library")
	if existing then existing:Destroy() end

	w.ScreenGui = Instance.new("ScreenGui")
	w.ScreenGui.Name = "67Library"
	w.ScreenGui.ResetOnSpawn = false
	w.ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	w.ScreenGui.IgnoreGuiInset = true
	w.ScreenGui.DisplayOrder = 100
	w.ScreenGui.Parent = parent

	w.MainFrame = Instance.new("Frame")
	w.MainFrame.Size = w.Size
	w.MainFrame.Position = UDim2.new(0.5, -w.Size.X.Offset / 2, 0.5, -w.Size.Y.Offset / 2)
	w.MainFrame.BackgroundColor3 = UILibrary.Theme.MainBackground
	w.MainFrame.BorderSizePixel = 0
	w.MainFrame.ClipsDescendants = true
	w.MainFrame.Parent = w.ScreenGui
	createStroke(w.MainFrame, UILibrary.Theme.StrokeColor, 1)

	w:CreateTitleBar()
	w:CreateTabBar()
	w:SetupDragging()
	if w.MinimizeKey then w:SetupMinimizeKeybind() end
	return w
end

function UILibrary:CreateTitleBar()
	self.TitleBar = Instance.new("Frame")
	self.TitleBar.Size = UDim2.new(1, 0, 0, UILibrary.Theme.TitleBarHeight)
	self.TitleBar.BackgroundColor3 = UILibrary.Theme.SecondaryBackground
	self.TitleBar.BorderSizePixel = 0
	self.TitleBar.ClipsDescendants = true
	self.TitleBar.Parent = self.MainFrame

	self.TitleLabel = Instance.new("TextLabel")
	self.TitleLabel.Size = UDim2.new(1, -50, 1, 0)
	self.TitleLabel.Position = UDim2.fromOffset(14, 0)
	self.TitleLabel.BackgroundTransparency = 1
	self.TitleLabel.Font = Enum.Font.GothamBold
	self.TitleLabel.Text = self.Title
	self.TitleLabel.TextColor3 = UILibrary.Theme.PrimaryText
	self.TitleLabel.TextSize = 15
	self.TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
	self.TitleLabel.Parent = self.TitleBar

	self.MinimizeButton = Instance.new("TextButton")
	self.MinimizeButton.Size = UDim2.fromOffset(28, 28)
	self.MinimizeButton.Position = UDim2.new(1, -36, 0.5, -14)
	self.MinimizeButton.Text = "−"
	self.MinimizeButton.Font = Enum.Font.GothamBold
	self.MinimizeButton.TextSize = 16
	self.MinimizeButton.BackgroundTransparency = 1
	self.MinimizeButton.TextColor3 = UILibrary.Theme.SecondaryText
	self.MinimizeButton.AutoButtonColor = false
	self.MinimizeButton.BorderSizePixel = 0
	self.MinimizeButton.Parent = self.TitleBar

	table.insert(self.Connections, self.MinimizeButton.MouseEnter:Connect(function()
		tween(self.MinimizeButton, { TextColor3 = UILibrary.Theme.AccentColor })
	end))
	table.insert(self.Connections, self.MinimizeButton.MouseLeave:Connect(function()
		tween(self.MinimizeButton, { TextColor3 = UILibrary.Theme.SecondaryText })
	end))
	table.insert(self.Connections, self.MinimizeButton.MouseButton1Click:Connect(function()
		self:ToggleMinimize()
	end))
end

function UILibrary:CreateTabBar()
	self.TabBar = Instance.new("Frame")
	self.TabBar.Size = UDim2.new(1, 0, 0, UILibrary.Theme.TabBarHeight)
	self.TabBar.Position = UDim2.new(0, 0, 0, UILibrary.Theme.TitleBarHeight)
	self.TabBar.BackgroundColor3 = UILibrary.Theme.SecondaryBackground
	self.TabBar.BorderSizePixel = 0
	self.TabBar.ClipsDescendants = true
	self.TabBar.Parent = self.MainFrame

	self.TabScrollingFrame = Instance.new("ScrollingFrame")
	self.TabScrollingFrame.Size = UDim2.new(1, 0, 1, 0)
	self.TabScrollingFrame.BackgroundTransparency = 1
	self.TabScrollingFrame.ScrollBarThickness = 4
	self.TabScrollingFrame.ScrollBarImageColor3 = UILibrary.Theme.ScrollBarColor
	self.TabScrollingFrame.AutomaticCanvasSize = Enum.AutomaticSize.X
	self.TabScrollingFrame.ScrollingDirection = Enum.ScrollingDirection.X
	self.TabScrollingFrame.VerticalScrollBarPosition = Enum.VerticalScrollBarPosition.Left
	self.TabScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
	self.TabScrollingFrame.Parent = self.TabBar

	local layout = Instance.new("UIListLayout")
	layout.FillDirection = Enum.FillDirection.Horizontal
	layout.Padding = UDim.new(0, 8)
	layout.HorizontalAlignment = Enum.HorizontalAlignment.Left
	layout.VerticalAlignment = Enum.VerticalAlignment.Center
	layout.Parent = self.TabScrollingFrame

	local padding = Instance.new("UIPadding")
	padding.PaddingLeft = UDim.new(0, 8)
	padding.PaddingRight = UDim.new(0, 8)
	padding.Parent = self.TabScrollingFrame

	layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		self.TabScrollingFrame.CanvasSize = UDim2.new(0, layout.AbsoluteContentSize.X, 0, 0)
	end)
end

function UILibrary:AddTab(name)
	local tab = {}
	tab.Name = name or "Tab"
	tab.Elements = {}

	tab.Button = Instance.new("TextButton")
	tab.Button.Size = UDim2.new(0, 110, 0, UILibrary.Theme.TabBarHeight - 10)
	tab.Button.BackgroundColor3 = UILibrary.Theme.ElementBackground
	tab.Button.Text = name
	tab.Button.Font = Enum.Font.GothamSemibold
	tab.Button.TextColor3 = UILibrary.Theme.SecondaryText
	tab.Button.TextSize = 13
	tab.Button.AutoButtonColor = false
	tab.Button.BorderSizePixel = 0
	tab.Button.Parent = self.TabScrollingFrame
	createCorner(tab.Button, UILibrary.Theme.ButtonCornerRadius)

	tab.Indicator = Instance.new("Frame")
	tab.Indicator.Size = UDim2.new(0.8, 0, 0, 2)
	tab.Indicator.Position = UDim2.new(0.1, 0, 1, -3)
	tab.Indicator.BackgroundColor3 = UILibrary.Theme.AccentColor
	tab.Indicator.BorderSizePixel = 0
	tab.Indicator.Visible = false
	tab.Indicator.Parent = tab.Button
	createCorner(tab.Indicator, 2)

	tab.Container = Instance.new("ScrollingFrame")
	tab.Container.Size = UDim2.new(1, 0, 1, -(UILibrary.Theme.TitleBarHeight + UILibrary.Theme.TabBarHeight))
	tab.Container.Position = UDim2.fromOffset(0, UILibrary.Theme.TitleBarHeight + UILibrary.Theme.TabBarHeight)
	tab.Container.BackgroundTransparency = 1
	tab.Container.ScrollBarThickness = 4
	tab.Container.ScrollBarImageColor3 = UILibrary.Theme.ScrollBarColor
	tab.Container.AutomaticCanvasSize = Enum.AutomaticSize.Y
	tab.Container.ScrollingDirection = Enum.ScrollingDirection.Y
	tab.Container.Active = true
	tab.Container.Visible = false
	tab.Container.CanvasSize = UDim2.new(0, 0, 0, 0)
	tab.Container.Parent = self.MainFrame

	local layout = Instance.new("UIListLayout")
	layout.Padding = UDim.new(0, UILibrary.Theme.ElementPadding)
	layout.SortOrder = Enum.SortOrder.LayoutOrder
	layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	layout.Parent = tab.Container

	local padding = Instance.new("UIPadding")
	padding.PaddingLeft = UDim.new(0, UILibrary.Theme.ContainerPadding)
	padding.PaddingTop = UDim.new(0, UILibrary.Theme.ContainerPadding)
	padding.PaddingRight = UDim.new(0, UILibrary.Theme.ContainerPadding)
	padding.PaddingBottom = UDim.new(0, UILibrary.Theme.ContainerPadding)
	padding.Parent = tab.Container

	tab.Button.MouseEnter:Connect(function()
		if self.ActiveTab ~= tab then
			tween(tab.Button, { BackgroundColor3 = UILibrary.Theme.HoverColor }, 0.15)
		end
	end)

	tab.Button.MouseLeave:Connect(function()
		if self.ActiveTab ~= tab then
			tween(tab.Button, { BackgroundColor3 = UILibrary.Theme.ElementBackground }, 0.15)
		end
	end)

	tab.Button.MouseButton1Click:Connect(function()
		self:SwitchTab(tab)
	end)

	table.insert(self.Tabs, tab)
	if not self.ActiveTab then
		self:SwitchTab(tab)
	end
	return tab
end

function UILibrary:SwitchTab(tab)
	if self.ActiveTab == tab then return end

	for _, t in ipairs(self.Tabs) do
		t.Container.Visible = false
		t.Indicator.Visible = false
		tween(t.Button, {
			BackgroundColor3 = UILibrary.Theme.ElementBackground,
			TextColor3 = UILibrary.Theme.SecondaryText
		}, 0.15)
	end

	self.ActiveTab = tab
	tab.Container.Visible = true
	tab.Indicator.Visible = true

	tween(tab.Button, {
		BackgroundColor3 = UILibrary.Theme.AccentColor,
		TextColor3 = UILibrary.Theme.PrimaryText
	}, 0.15)

	local canvasPositionX = self.TabScrollingFrame.CanvasPosition.X
	local tabAbsolutePositionX = tab.Button.AbsolutePosition.X
	local tabAbsoluteSizeX = tab.Button.AbsoluteSize.X
	local frameAbsoluteSizeX = self.TabScrollingFrame.AbsoluteSize.X
	local scrollingFrameAbsolutePositionX = self.TabScrollingFrame.AbsolutePosition.X

	local visibleLeft = scrollingFrameAbsolutePositionX
	local visibleRight = visibleLeft + frameAbsoluteSizeX

	local tabLeft = tabAbsolutePositionX
	local tabRight = tabLeft + tabAbsoluteSizeX

	if tabLeft < visibleLeft then
		self.TabScrollingFrame.CanvasPosition = Vector2.new(canvasPositionX - (visibleLeft - tabLeft) - 8, 0)
	elseif tabRight > visibleRight then
		self.TabScrollingFrame.CanvasPosition = Vector2.new(canvasPositionX + (tabRight - visibleRight) + 8, 0)
	end
end

function UILibrary:AddToggle(tab, config)
	config = config or {}
	local label = config.Label or "Toggle"
	local default = config.Default or false
	local callback = config.Callback or function() end
	local val = default

	local container = Instance.new("Frame")
	container.Size = UDim2.new(1, 0, 0, UILibrary.Theme.ElementHeight)
	container.BackgroundColor3 = UILibrary.Theme.ElementBackground
	container.BorderSizePixel = 0
	container.Parent = tab.Container
	createCorner(container, UILibrary.Theme.CornerRadius)

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, -60, 1, 0)
	textLabel.Position = UDim2.fromOffset(12, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Font = Enum.Font.GothamSemibold
	textLabel.Text = label
	textLabel.TextColor3 = UILibrary.Theme.SecondaryText
	textLabel.TextSize = 13
	textLabel.TextXAlignment = Enum.TextXAlignment.Left
	textLabel.Parent = container

	local toggleFrame = Instance.new("Frame")
	toggleFrame.Size = UDim2.fromOffset(44, 22)
	toggleFrame.Position = UDim2.new(1, -52, 0.5, -11)
	toggleFrame.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
	toggleFrame.Parent = container
	createCorner(toggleFrame, 11)

	local knob = Instance.new("Frame")
	knob.Size = UDim2.fromOffset(18, 18)
	knob.Position = UDim2.fromOffset(2, 2)
	knob.BackgroundColor3 = UILibrary.Theme.MutedText
	knob.Parent = toggleFrame
	createCorner(knob, 9)

	local button = Instance.new("TextButton")
	button.Size = UDim2.new(1, 0, 1, 0)
	button.BackgroundTransparency = 1
	button.Text = ""
	button.Parent = container

	local function update()
		if val then
			tween(toggleFrame, { BackgroundColor3 = UILibrary.Theme.AccentColor }, 0.2)
			tween(knob, { Position = UDim2.fromOffset(24, 2), BackgroundColor3 = UILibrary.Theme.PrimaryText }, 0.2)
		else
			tween(toggleFrame, { BackgroundColor3 = UILibrary.Theme.TertiaryBackground }, 0.2)
			tween(knob, { Position = UDim2.fromOffset(2, 2), BackgroundColor3 = UILibrary.Theme.MutedText }, 0.2)
		end
	end

	button.MouseEnter:Connect(function()
		tween(container, { BackgroundColor3 = UILibrary.Theme.HoverColor }, 0.15)
	end)
	button.MouseLeave:Connect(function()
		tween(container, { BackgroundColor3 = UILibrary.Theme.ElementBackground }, 0.15)
	end)
	button.MouseButton1Click:Connect(function()
		val = not val
		update()
		callback(val)
	end)

	update()
	return container
end

function UILibrary:AddSlider(tab, config)
	config = config or {}
	local label = config.Label or "Slider"
	local min = config.Min or 0
	local max = config.Max or 100
	local default = config.Default or min
	local increment = config.Increment or 1
	local callback = config.Callback or function() end

	-- Auto-detect decimals based on increment
	local function getDecimals()
		if increment >= 1 then
			return 0
		end
		
		local incrementStr = tostring(increment)
		local decimalPart = incrementStr:match("%.(%d+)")
		if decimalPart then
			return #decimalPart
		end
		return 0
	end

	local decimals = getDecimals()

	local function snap(v)
		local s = math.floor((v / increment) + 0.5) * increment
		return math.clamp(s, min, max)
	end

	local function format(v)
		if decimals > 0 then
			-- Remove trailing zeros and unnecessary decimal point
			local formatted = string.format("%." .. decimals .. "f", v)
			-- Remove trailing zeros
			formatted = formatted:gsub("0+$", "")
			-- Remove trailing decimal point if no decimals left
			formatted = formatted:gsub("%.$", "")
			return formatted
		else
			return tostring(math.floor(v))
		end
	end

	local currentValue = snap(default)

	local container = Instance.new("Frame")
	container.Size = UDim2.new(1, 0, 0, UILibrary.Theme.ElementHeight + 16) -- Added more height for breathing room
	container.BackgroundColor3 = UILibrary.Theme.ElementBackground
	container.BorderSizePixel = 0
	container.Parent = tab.Container
	createCorner(container, UILibrary.Theme.CornerRadius)

	local labelFrame = Instance.new("Frame")
	labelFrame.Size = UDim2.new(1, -16, 0, 20)
	labelFrame.Position = UDim2.fromOffset(12, 8) -- Added top padding
	labelFrame.BackgroundTransparency = 1
	labelFrame.Parent = container

	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(0.5, 0, 1, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.GothamSemibold
	nameLabel.Text = label
	nameLabel.TextColor3 = UILibrary.Theme.SecondaryText
	nameLabel.TextSize = 13
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.Parent = labelFrame

	local valueLabel = Instance.new("TextLabel")
	valueLabel.Size = UDim2.new(0.5, 0, 1, 0)
	valueLabel.Position = UDim2.new(0.5, 0, 0, 0)
	valueLabel.BackgroundTransparency = 1
	valueLabel.Font = Enum.Font.GothamBold
	valueLabel.TextColor3 = UILibrary.Theme.AccentColor
	valueLabel.TextSize = 13
	valueLabel.TextXAlignment = Enum.TextXAlignment.Right
	valueLabel.Parent = labelFrame

	local barBack = Instance.new("Frame")
	barBack.Size = UDim2.new(1, -24, 0, 8)
	barBack.Position = UDim2.new(0, 12, 1, -16) -- Positioned at bottom with padding
	barBack.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
	barBack.BorderSizePixel = 0
	barBack.Parent = container
	createCorner(barBack, 4)

	local fill = Instance.new("Frame")
	fill.Size = UDim2.new(0, 0, 1, 0)
	fill.BackgroundColor3 = UILibrary.Theme.AccentColor
	fill.BorderSizePixel = 0
	fill.Parent = barBack
	createCorner(fill, 4)

	local handle = Instance.new("Frame")
	handle.Size = UDim2.new(0, 14, 0, 14)
	handle.BackgroundColor3 = UILibrary.Theme.PrimaryText
	handle.BorderSizePixel = 0
	handle.Parent = barBack
	createCorner(handle, 7)

	local function updateDisplay()
		valueLabel.Text = format(currentValue)
		local p = (currentValue - min) / (max - min)
		fill.Size = UDim2.new(p, 0, 1, 0)
		handle.Position = UDim2.new(p, -7, 0.5, -7)
	end

	local dragging = false
	local function startDrag(input)
		dragging = true
		local function update(inputPosition)
			local x = inputPosition.X - barBack.AbsolutePosition.X
			local percent = math.clamp(x / barBack.AbsoluteSize.X, 0, 1)
			currentValue = snap(min + percent * (max - min))
			updateDisplay()
			callback(currentValue)
		end

		update(input.Position)

		local moveConn, endConn
		moveConn = UIS.InputChanged:Connect(function(i)
			if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
				update(i.Position)
			end
		end)

		endConn = UIS.InputEnded:Connect(function(i)
			if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
				dragging = false
				moveConn:Disconnect()
				endConn:Disconnect()
			end
		end)
	end

	barBack.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
			startDrag(i)
		end
	end)

	updateDisplay()
	return container
end

function UILibrary:AddButton(tab, config)
	config = config or {}
	local label = config.Label or "Button"
	local callback = config.Callback or function() end

	local b = Instance.new("TextButton")
	b.Size = UDim2.new(1, 0, 0, UILibrary.Theme.ElementHeight)
	b.BackgroundColor3 = UILibrary.Theme.AccentColor
	b.TextColor3 = UILibrary.Theme.PrimaryText
	b.Font = Enum.Font.GothamSemibold
	b.Text = label
	b.TextSize = 13
	b.AutoButtonColor = false
	b.BorderSizePixel = 0
	b.Parent = tab.Container
	createCorner(b, UILibrary.Theme.CornerRadius)

	b.MouseEnter:Connect(function()
		tween(b, { BackgroundColor3 = UILibrary.Theme.AccentHover }, 0.15)
	end)
	b.MouseLeave:Connect(function()
		tween(b, { BackgroundColor3 = UILibrary.Theme.AccentColor }, 0.15)
	end)
	b.MouseButton1Click:Connect(function()
		tween(b, { BackgroundColor3 = UILibrary.Theme.AccentDark }, 0.05)
		task.wait(0.05)
		tween(b, { BackgroundColor3 = UILibrary.Theme.AccentColor }, 0.1)
		callback()
	end)
	return b
end

function UILibrary:AddLabel(tab, text)
	local l = Instance.new("TextLabel")
	l.Size = UDim2.new(1, 0, 0, UILibrary.Theme.ElementHeight)
	l.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
	l.TextColor3 = UILibrary.Theme.TertiaryText
	l.Font = Enum.Font.Gotham
	l.Text = text or "Label"
	l.TextSize = 13
	l.TextXAlignment = Enum.TextXAlignment.Left
	l.Parent = tab.Container
	createCorner(l, UILibrary.Theme.CornerRadius)

	local p = Instance.new("UIPadding")
	p.PaddingLeft = UDim.new(0, 12)
	p.Parent = l
	return l
end

-- TextBox Element
function UILibrary:AddTextBox(tab, config)
	config = config or {}
	local label = config.Label or "Text Box"
	local placeholder = config.Placeholder or "Enter text..."
	local default = config.Default or ""
	local callback = config.Callback or function() end

	local container = Instance.new("Frame")
	container.Size = UDim2.new(1, 0, 0, UILibrary.Theme.ElementHeight)
	container.BackgroundColor3 = UILibrary.Theme.ElementBackground
	container.BorderSizePixel = 0
	container.Parent = tab.Container
	createCorner(container, UILibrary.Theme.CornerRadius)

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(0.4, -8, 1, 0)
	textLabel.Position = UDim2.fromOffset(12, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Font = Enum.Font.GothamSemibold
	textLabel.Text = label
	textLabel.TextColor3 = UILibrary.Theme.SecondaryText
	textLabel.TextSize = 13
	textLabel.TextXAlignment = Enum.TextXAlignment.Left
	textLabel.Parent = container

	local textBoxFrame = Instance.new("Frame")
	textBoxFrame.Size = UDim2.new(0.6, -12, 0, 26)
	textBoxFrame.Position = UDim2.new(0.4, 8, 0.5, -13)
	textBoxFrame.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
	textBoxFrame.BorderSizePixel = 0
	textBoxFrame.Parent = container
	createCorner(textBoxFrame, UILibrary.Theme.ButtonCornerRadius)

	local textBox = Instance.new("TextBox")
	textBox.Size = UDim2.new(1, -12, 1, 0)
	textBox.Position = UDim2.fromOffset(6, 0)
	textBox.BackgroundTransparency = 1
	textBox.Font = Enum.Font.Gotham
	textBox.Text = default
	textBox.PlaceholderText = placeholder
	textBox.TextColor3 = UILibrary.Theme.PrimaryText
	textBox.PlaceholderColor3 = UILibrary.Theme.MutedText
	textBox.TextSize = 13
	textBox.ClearTextOnFocus = false
	textBox.Parent = textBoxFrame

	-- Focus effects
	textBox.Focused:Connect(function()
		tween(textBoxFrame, { BackgroundColor3 = UILibrary.Theme.HoverColor }, 0.15)
	end)

	textBox.FocusLost:Connect(function(enterPressed)
		tween(textBoxFrame, { BackgroundColor3 = UILibrary.Theme.TertiaryBackground }, 0.15)
		callback(textBox.Text, enterPressed)
	end)

	-- Hover effects for the entire container
	container.MouseEnter:Connect(function()
		tween(container, { BackgroundColor3 = UILibrary.Theme.HoverColor }, 0.15)
	end)
	container.MouseLeave:Connect(function()
		tween(container, { BackgroundColor3 = UILibrary.Theme.ElementBackground }, 0.15)
	end)

	return container
end

-- NEW: Dropdown Element (PROPERLY POSITIONED VERSION)
function UILibrary:AddDropdown(tab, config)
	config = config or {}
	local label = config.Label or "Dropdown"
	local options = config.Options or {}
	local default = config.Default or (options[1] or "")
	local callback = config.Callback or function() end

	local container = Instance.new("Frame")
	container.Size = UDim2.new(1, 0, 0, UILibrary.Theme.ElementHeight)
	container.BackgroundColor3 = UILibrary.Theme.ElementBackground
	container.BorderSizePixel = 0
	container.ClipsDescendants = true
	container.Parent = tab.Container
	createCorner(container, UILibrary.Theme.CornerRadius)

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(0.6, -8, 1, 0)
	textLabel.Position = UDim2.fromOffset(12, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Font = Enum.Font.GothamSemibold
	textLabel.Text = label
	textLabel.TextColor3 = UILibrary.Theme.SecondaryText
	textLabel.TextSize = 13
	textLabel.TextXAlignment = Enum.TextXAlignment.Left
	textLabel.Parent = container

	local dropdownFrame = Instance.new("Frame")
	dropdownFrame.Size = UDim2.new(0.4, -12, 0, 26)
	dropdownFrame.Position = UDim2.new(0.6, 8, 0.5, -13)
	dropdownFrame.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
	dropdownFrame.BorderSizePixel = 0
	dropdownFrame.ClipsDescendants = true
	dropdownFrame.Parent = container
	createCorner(dropdownFrame, UILibrary.Theme.ButtonCornerRadius)

	local selectedLabel = Instance.new("TextLabel")
	selectedLabel.Size = UDim2.new(1, -30, 1, 0)
	selectedLabel.Position = UDim2.fromOffset(8, 0)
	selectedLabel.BackgroundTransparency = 1
	selectedLabel.Font = Enum.Font.Gotham
	selectedLabel.Text = default
	selectedLabel.TextColor3 = UILibrary.Theme.PrimaryText
	selectedLabel.TextSize = 13
	selectedLabel.TextXAlignment = Enum.TextXAlignment.Left
	selectedLabel.Parent = dropdownFrame

	local arrow = Instance.new("TextLabel")
	arrow.Size = UDim2.new(0, 20, 1, 0)
	arrow.Position = UDim2.new(1, -20, 0, 0)
	arrow.BackgroundTransparency = 1
	arrow.Font = Enum.Font.GothamBold
	arrow.Text = "▼"
	arrow.TextColor3 = UILibrary.Theme.MutedText
	arrow.TextSize = 10
	arrow.Parent = dropdownFrame

	local dropdownButton = Instance.new("TextButton")
	dropdownButton.Size = UDim2.new(1, 0, 1, 0)
	dropdownButton.BackgroundTransparency = 1
	dropdownButton.Text = ""
	dropdownButton.Parent = dropdownFrame

	-- Dropdown list
	local listFrame = Instance.new("Frame")
	listFrame.Size = UDim2.new(1, 0, 0, 0) -- Will be updated when opened
	listFrame.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
	listFrame.BorderSizePixel = 0
	listFrame.Visible = false
	listFrame.ClipsDescendants = true
	listFrame.ZIndex = 101
	listFrame.Parent = self.ScreenGui
	createCorner(listFrame, UILibrary.Theme.ButtonCornerRadius)
	createStroke(listFrame, UILibrary.Theme.StrokeColor, 1)

	local listLayout = Instance.new("UIListLayout")
	listLayout.Padding = UDim.new(0, 1)
	listLayout.SortOrder = Enum.SortOrder.LayoutOrder
	listLayout.Parent = listFrame

	local isOpen = false
	local currentSelection = default

	local function updateListSize()
		local count = #options
		local maxHeight = math.min(count * 26, 130)
		listFrame.Size = UDim2.new(0, dropdownFrame.AbsoluteSize.X, 0, maxHeight)
	end

	local function updateListPosition()
		if not dropdownFrame or not dropdownFrame:IsDescendantOf(game) then return end
		
		-- Wait for the absolute position to be available
		repeat task.wait() until dropdownFrame.AbsolutePosition ~= Vector3.zero
		
		local dropdownAbsPos = dropdownFrame.AbsolutePosition
		local dropdownAbsSize = dropdownFrame.AbsoluteSize
		
		-- Position directly below the dropdown button
		listFrame.Position = UDim2.new(
			0, dropdownAbsPos.X,
			0, dropdownAbsPos.Y + dropdownAbsSize.Y + 2
		)
		
		-- Set the width to match the dropdown button
		listFrame.Size = UDim2.new(0, dropdownAbsSize.X, 0, listFrame.Size.Y.Offset)
	end

	local function closeDropdown()
		if not isOpen then return end
		isOpen = false
		tween(listFrame, { Size = UDim2.new(0, dropdownFrame.AbsoluteSize.X, 0, 0) }, 0.2)
		tween(arrow, { Rotation = 0 }, 0.2)
		task.wait(0.2)
		listFrame.Visible = false
	end

	local function openDropdown()
		if isOpen then return end
		isOpen = true
		
		-- Update position and size before showing
		updateListPosition()
		updateListSize()
		
		listFrame.Visible = true
		tween(listFrame, { 
			Size = UDim2.new(0, dropdownFrame.AbsoluteSize.X, 0, math.min(#options * 26, 130)) 
		}, 0.2)
		tween(arrow, { Rotation = 180 }, 0.2)
	end

	local function selectOption(option)
		currentSelection = option
		selectedLabel.Text = option
		closeDropdown()
		callback(option)
	end

	-- Create option buttons
	for _, option in ipairs(options) do
		local optionButton = Instance.new("TextButton")
		optionButton.Size = UDim2.new(1, 0, 0, 25)
		optionButton.BackgroundColor3 = UILibrary.Theme.TertiaryBackground
		optionButton.TextColor3 = UILibrary.Theme.PrimaryText
		optionButton.Font = Enum.Font.Gotham
		optionButton.Text = option
		optionButton.TextSize = 13
		optionButton.AutoButtonColor = false
		optionButton.BorderSizePixel = 0
		optionButton.ZIndex = 102
		optionButton.Parent = listFrame

		optionButton.MouseEnter:Connect(function()
			tween(optionButton, { BackgroundColor3 = UILibrary.Theme.HoverColor }, 0.15)
		end)
		optionButton.MouseLeave:Connect(function()
			tween(optionButton, { BackgroundColor3 = UILibrary.Theme.TertiaryBackground }, 0.15)
		end)
		
		optionButton.MouseButton1Click:Connect(function()
			selectOption(option)
		end)
		
		optionButton.TouchTap:Connect(function()
			selectOption(option)
		end)
	end

	-- Dropdown button functionality
	dropdownButton.MouseButton1Click:Connect(function()
		if isOpen then
			closeDropdown()
		else
			openDropdown()
		end
	end)
	
	dropdownButton.TouchTap:Connect(function()
		if isOpen then
			closeDropdown()
		else
			openDropdown()
		end
	end)

	-- Close dropdown when clicking outside
	local closeConnection
	closeConnection = UIS.InputBegan:Connect(function(input)
		if isOpen then
			if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
				local clickedOnDropdown = false
				local target = input.Parent
				
				while target do
					if target == dropdownFrame or target == listFrame then
						clickedOnDropdown = true
						break
					end
					target = target.Parent
				end
				
				if not clickedOnDropdown then
					closeDropdown()
				end
			end
		end
	end)

	-- Update dropdown position when window moves
	local function updateDropdownPosition()
		if isOpen then
			updateListPosition()
		end
	end

	-- Listen for changes that affect position
	self.MainFrame:GetPropertyChangedSignal("Position"):Connect(updateDropdownPosition)
	self.MainFrame:GetPropertyChangedSignal("Size"):Connect(updateDropdownPosition)
	tab.Container:GetPropertyChangedSignal("CanvasPosition"):Connect(updateDropdownPosition)

	-- Hover effects
	container.MouseEnter:Connect(function()
		tween(container, { BackgroundColor3 = UILibrary.Theme.HoverColor }, 0.15)
	end)
	container.MouseLeave:Connect(function()
		tween(container, { BackgroundColor3 = UILibrary.Theme.ElementBackground }, 0.15)
	end)

	-- Clean up
	container.Destroying:Connect(function()
		if closeConnection then
			closeConnection:Disconnect()
		end
		if listFrame then
			listFrame:Destroy()
		end
	end)

	return container
end

function UILibrary:SetupDragging()
	local dragging = false
	local dragStart, startPos

	local function update(input)
		local delta = input.Position - dragStart
		self.MainFrame.Position = UDim2.new(
			startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y
		)
	end

	self.TitleBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = self.MainFrame.Position

			local connEnd
			connEnd = input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
					connEnd:Disconnect()
				end
			end)
		end
	end)

	UIS.InputChanged:Connect(function(input)
		if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
			update(input)
		end
	end)
end

function UILibrary:SetupMinimizeKeybind()
	table.insert(self.Connections, UIS.InputBegan:Connect(function(i, g)
		if not g and i.KeyCode == self.MinimizeKey then
			self:ToggleMinimize()
		end
	end))
end

function UILibrary:ToggleMinimize()
	self.IsMinimized = not self.IsMinimized
	self.MinimizeButton.Text = self.IsMinimized and "+" or "−"

	if self.IsMinimized then
		tween(self.MainFrame, { Size = UDim2.fromOffset(self.MainFrame.Size.X.Offset, UILibrary.Theme.TitleBarHeight) }, 0.25)
		if self.ActiveTab then self.ActiveTab.Container.Visible = false end
		self.TabBar.Visible = false
	else
		tween(self.MainFrame, {
			Size = UDim2.fromOffset(360, 333),
			Position = UDim2.new(0.5, -180, 0.5, -166.5)
		}, 0.25)
		if self.ActiveTab then self.ActiveTab.Container.Visible = true end
		self.TabBar.Visible = true
	end
end

function UILibrary:Destroy()
	for _, c in ipairs(self.Connections) do
		pcall(function()
			if c and c.Disconnect then c:Disconnect() end
		end)
	end
	if self.ScreenGui then
		self.ScreenGui:Destroy()
	end
	self.Connections, self.Elements, self.Tabs = {}, {}, {}
end

return UILibrary